stages:
  - build
#  - format
  - lint
#  - typecheck
  - migrate
  - test
  - deploy

build-job:
  stage: build
  before_script:
    - cp ${ENV_DOCKER} .env
    - cp ${ENV_TEST} .test.env
  script:
    - docker build -t booking-app-image:0.7 .

#lint-job:
#  stage: lint
#  script:
#    -
#
format-job:
  stage: lint
  image: python:3.11.13
  script:
    - pip install ruff
    - ruff format --check .

lint-job:
  stage: lint
  image: python:3.11.13
  script:
    - pip install ruff
    - ruff check .

typecheck-job:
  stage: typecheck
  script:
    - docker run --rm --network booking-network booking-app-image:0.7 poetry run pyright
#
migrate-job:
  stage: migrate
  script:
    - docker run --rm --network booking-network booking-app-image:0.7 poetry run alembic upgrade head

test-job:
  stage: test
  script:
    - docker run --rm --network booking-network booking-app-image:0.7 poetry run pytest


deploy-job:
  stage: deploy
  environment: production
  script:
    - docker compose --file docker-compose-ci.yml up -d
    - docker exec nginx-booking nginx -s reload
